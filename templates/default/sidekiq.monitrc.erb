check process gitlab_sidekiq with pidfile <%= @sidekiq_pid_path %>
  alert <%= @notify_email %>
  start program = "/bin/su - <%= @gitlab_user %> -c 'RAILS_ENV=production <%= @gitlab_path %>/script/background_jobs start'" with timeout 80 seconds
  stop program = "/bin/su - <%= @gitlab_user %> -c 'RAILS_ENV=production <%= @gitlab_path %>/script/background_jobs stop'" with timeout 40 seconds
  # Assuming our server has two cores, 40% totalcpu means pinning 80% of a single core
  if totalcpu is greater than 40% for 10 cycles then restart
  if totalmem is greater than 225 MB for 10 cycles then restart
  if 5 restart within 5 cycles then alert
  group gitlab_sidekiq

check program test_sidekiq_max_workers with path "<%= @app_home %>/bin/test_sidekiq_max_workers.sh"
  alert <%= @notify_email %>
  if status = 0 then exec "/usr/bin/monit restart gitlab_sidekiq"
